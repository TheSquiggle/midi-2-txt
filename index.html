<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI to Text Converter (No Instruments, No Piano Roll)</title>
</head>
<body>

<h2>Upload a MIDI file</h2>
<input type="file" id="fileInput" accept=".mid">
<button onclick="convertMidi()">Convert to Text</button>
<br><br>
<progress id="progressBar" value="0" max="100" style="width:100%; display:none;"></progress>
<br><br>
<div id="noteDisplay"></div>

<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2"></script>
<script>
let midi;

function convertMidi() {
    const fileInput = document.getElementById('fileInput');
    const progressBar = document.getElementById('progressBar');

    if (fileInput.files.length === 0) {
        alert('Please upload a MIDI file.');
        return;
    }

    progressBar.style.display = 'block';
    progressBar.value = 0;

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(event) {
        try {
            midi = new Midi(event.target.result);
        } catch (error) {
            alert('Failed to read MIDI file. Please check the file format.');
            progressBar.style.display = 'none';
            return;
        }

        let allNotes = [];

        // Collect all notes from all tracks
        midi.tracks.forEach(track => {
            track.notes.forEach(note => {
                allNotes.push({
                    pitch: note.midi,
                    length: note.duration.toFixed(3),
                    time: note.time.toFixed(3)
                });
            });
        });

        // Sort all notes by time
        allNotes.sort((a, b) => parseFloat(a.time) - parseFloat(b.time));

        // Generate the text content
        let textContent = '';
        allNotes.forEach(note => {
            textContent += `${note.pitch}:${note.length}:${note.time}\n`;
        });

        // Create and trigger the download
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'midi_notes.txt';
        a.click();

        URL.revokeObjectURL(url);
        progressBar.value = 100;
        progressBar.style.display = 'none';
    };

    reader.readAsArrayBuffer(file);
}
</script>

</body>
</html>
